<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>搜索验证</title>
  <style>
    body { font-family: system-ui; max-width: 900px; margin: 20px auto; }
    .item { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .item a { font-weight: bold; text-decoration: none; }
    .muted { color: #666; }
  </style>
</head>
<body>

<h1>搜索验证（基于书源规则）</h1>

<label>
  选择书源
  <select id="sourceSelect"></select>
</label>

<label>
  关键词
  <input id="keyword" value="水边之夜" />
</label>

<button onclick="search()">搜索</button>

<div id="result"></div>

<script>
const KEY = 'book_sources';

function loadSources() {
  return JSON.parse(localStorage.getItem(KEY) || '[]');
}

function init() {
  const sources = loadSources();
  sourceSelect.innerHTML = sources.map(
    s => `<option value="${s.name}">${s.name}</option>`
  ).join('');
}

async function search() {
  const sources = loadSources();
  const src = sources.find(s => s.name === sourceSelect.value);
  if (!src) return;

  const url = `/search?keyword=${encodeURIComponent(keyword.value)}`;

  const html = await fetch(url).then(r => r.text());

  const doc = new DOMParser().parseFromString(html, 'text/html');
  const items = [...doc.querySelectorAll(src.search.list)];

  const books = items.map(el => {
    const a = el.querySelector(src.search.bookUrl || 'a');
    return {
      name: el.querySelector(src.search.name)?.textContent?.trim(),
      author: src.search.author
        ? el.querySelector(src.search.author)?.textContent?.trim()
        : '',
      href: a?.getAttribute('href')
    };
  }).filter(b => b.name && b.href);

  render(books);
}

function render(list) {
  result.innerHTML = list.map(b => `
    <div class="item">
      <a href="${b.href}" target="_blank">${b.name}</a>
      ${b.author ? `<div class="muted">${b.author}</div>` : ''}
    </div>
  `).join('');
}

init();
</script>
</body>
</html>
